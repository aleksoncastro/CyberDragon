<div class="profile-layout">
  <!-- Sidebar Navigation -->
  <div class="sidebar">
    <div class="sidebar-item" [class.active]="activeSection === 'conta'" (click)="setActiveSection('conta')">
      <mat-icon class="sidebar-icon">person</mat-icon>
      <span class="sidebar-text">Minha Conta</span>
    </div>
    <div class="sidebar-item" [class.active]="activeSection === 'pedidos'" (click)="setActiveSection('pedidos')">
      <mat-icon class="sidebar-icon">local_shipping</mat-icon>
      <span class="sidebar-text">Meus Pedidos</span>
    </div>
    <div class="sidebar-item" [class.active]="activeSection === 'favoritos'" (click)="setActiveSection('favoritos')">
      <mat-icon class="sidebar-icon">favorite</mat-icon>
      <span class="sidebar-text">Meus Favoritos</span>
    </div>
    <div class="sidebar-item" [class.active]="activeSection === 'enderecos'" (click)="setActiveSection('enderecos')">
      <mat-icon class="sidebar-icon">place</mat-icon>
      <span class="sidebar-text">Endereços</span>
    </div>
    <div class="sidebar-item" [class.active]="activeSection === 'dados'" (click)="setActiveSection('dados')">
      <mat-icon class="sidebar-icon">assignment</mat-icon>
      <span class="sidebar-text">Meus dados</span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Breadcrumb -->
    <div class="breadcrumb">
      <a class="caminhos" routerLink="/"><mat-icon>home</mat-icon></a>
      <ng-container *ngFor="let breadcrumb of breadcrumbs; let last = last">
        <span class="breadcrumb-separator">></span>
        <a *ngIf="!last" [routerLink]="breadcrumb.url">{{ breadcrumb.label }}</a>
        <span *ngIf="last">{{ breadcrumb.label }}</span>
      </ng-container>
    </div>


    <!-- Minha Conta Dashboard -->
    <div *ngIf="activeSection === 'conta'" class="dashboard-section">
      <!-- Header com saudação -->
      <div class="welcome-header">
        <div class="welcome-avatar">
          <div class="avatar-container">
            <!-- Avatar with upload overlay -->
            <div class="avatar-wrapper">
              <div class="avatar-circle mat-elevation-z3">
                <ng-container *ngIf="usuario?.usuario?.listaImagem && imagemUrl; else inicial">
                  <img [src]="imagemUrl" alt="Imagem de perfil" class="profile-image" />
                </ng-container>
                <ng-template #inicial>
                  <span class="avatar-initial">{{ getFirstName().charAt(0).toUpperCase() }}</span>
                </ng-template>
              </div>

              <!-- Upload overlay with hover effect -->
              <div class="avatar-overlay" (click)="fileInput.click()">
                <mat-icon>photo_camera</mat-icon>
                <span>Alterar foto</span>
              </div>

              <!-- Upload progress indicator -->
            </div>

            <!-- Hidden file input -->
            <input type="file" hidden #fileInput accept="image/*" (change)="carregarImagemSelecionada($event)" />

            <!-- Image options menu -->
            <div class="avatar-actions" *ngIf="usuario?.usuario?.listaImagem">
              <button mat-button color="primary" [matMenuTriggerFor]="photoMenu" class="photo-options-button">
                <mat-icon>more_horiz</mat-icon>
                <span>Opções</span>
              </button>

              <mat-menu class="menu-avatar" #photoMenu="matMenu">
                <button mat-menu-item (click)="fileInput.click()">
                  <mat-icon>edit</mat-icon>
                  <span>Alterar foto</span>
                </button>
                <button mat-menu-item (click)="removerImagem()" color="warn">
                  <mat-icon>delete</mat-icon>
                  <span>Remover foto</span>
                </button>
              </mat-menu>
            </div>

          </div>
        </div>


        <div class="welcome-content">
          <h1 class="welcome-title">Olá, {{ getFirstName() }}</h1>
          <p class="welcome-description">
            Aqui você encontra todas as informações relacionadas a sua conta, como acompanhar seus últimos pedidos,
            adicionar novos endereços...
          </p>
        </div>
      </div>

      <!-- Grid de Cards Principais -->
      <div class="main-cards-grid">
        <div class="main-card" (click)="setActiveSection('dados')">
          <mat-icon class="card-icon">person</mat-icon>
          <span class="card-title">MEUS DADOS</span>
        </div>
        <div class="main-card" (click)="setActiveSection('pedidos')">
          <mat-icon class="card-icon">local_shipping</mat-icon>
          <span class="card-title">MEUS PEDIDOS</span>
        </div>
        <div class="main-card" (click)="setActiveSection('enderecos')">
          <mat-icon class="card-icon">place</mat-icon>
          <span class="card-title">ENDEREÇOS</span>
        </div>
        <div class="main-card" (click)="setActiveSection('favoritos')">
          <mat-icon class="card-icon">favorite</mat-icon>
          <span class="card-title">FAVORITOS</span>
        </div>
      </div>

      <!-- Últimos Pedidos -->
      <div class="recent-orders-section" *ngIf="pedidos.length > 0">
        <div class="section-header">
          <h2 class="section-title">
            <mat-icon class="section-icon">local_shipping</mat-icon>
            ÚLTIMOS PEDIDOS
          </h2>
          <button class="view-all-btn" (click)="setActiveSection('pedidos')">VER TODOS</button>
        </div>

        <div class="order-card-detailed" *ngFor="let pedido of pedidos.slice(0, 3)">
          <div class="order-main-info">
            <div class="order-detail">
              <strong>Número do Pedido</strong>
              <span>#{{ pedido.id }}</span>
            </div>
            <div class="order-detail">
              <strong>Pagamento</strong>
              <span>{{ getTipoPagamentoLabel(pedido.tipoPagamento) }}</span>
            </div>
            <div class="order-detail">
              <strong>Data</strong>
              <span>{{ pedido.data | date:'dd/MM/yyyy HH:mm:ss' }}</span>
            </div>
            <div class="order-detail">
              <strong>Valor Total</strong>
              <span>{{ pedido.valorTotal | currency:'BRL':'symbol':'1.2-2' }}</span>
            </div>
            <div class="order-detail">
              <strong>Status: {{ getUltimoStatus(pedido) }}</strong>
            </div>
          </div>

          <div class="order-actions">
            <button class="action-btn primary">VER PEDIDO</button>
            <button class="action-btn primary">RASTREAR PEDIDO</button>
            <button class="action-btn primary">CONTATAR SUPORTE</button>
          </div>

          <div class="order-status">
            <mat-icon class="status-icon">local_shipping</mat-icon>
            <span class="status-text">{{ getUltimoStatus(pedido) }}</span>
            <span class="status-date">{{ pedido.data | date:'dd/MM/yyyy HH:mm:ss' }}</span>
          </div>
        </div>
      </div>

      <!-- Grid Inferior: Endereços e Dados -->
      <div class="bottom-grid">
        <!-- Endereços -->
        <div class="bottom-section">
          <div class="section-header">
            <h2 class="section-title">
              <mat-icon class="section-icon">place</mat-icon>
              ENDEREÇOS
            </h2>
            <button class="view-all-btn" (click)="setActiveSection('enderecos')">VER TODOS</button>
          </div>

          <div class="address-cards" *ngIf="usuario.enderecos.length > 0">
            <div class="address-card-compact" *ngFor="let endereco of usuario.enderecos.slice(0, 2)">
              <h4 class="address-title">Endereço de Entrega Padrão</h4>
              <div class="address-info-compact">
                <p><strong>{{ usuario.nome }}</strong></p>
                <p>{{ endereco.rua }}, {{ endereco.numero }}</p>
                <p>{{ endereco.bairro }}</p>
                <p>{{ endereco.cidade }}, {{ endereco.estado }} - {{ endereco.cep }}</p>
                <p *ngIf="usuario.telefones.length > 0">
                  Tel: ({{ usuario.telefones[0].codigoArea }}) {{ usuario.telefones[0].numero }}
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Meus Dados -->
        <div class="bottom-section">
          <div class="section-header">
            <h2 class="section-title">
              <mat-icon class="section-icon">person</mat-icon>
              MEUS DADOS
            </h2>
            <button class="view-all-btn" (click)="setActiveSection('dados')">VER TODOS</button>
          </div>

          <div class="user-data-compact">
            <h4 class="data-title">Informações de Acesso</h4>
            <div class="user-info-compact">
              <p><mat-icon class="info-icon">person</mat-icon> {{ usuario.nome }}</p>
              <p><mat-icon class="info-icon">email</mat-icon> {{ usuario.usuario?.email }}</p>
            </div>

            <div class="user-actions">
              <button class="action-btn primary">EDITAR</button>
              <button class="action-btn primary">MUDAR SENHA</button>
              <button class="action-btn danger">EXCLUIR MINHA CONTA</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Outras Seções -->
    <div *ngIf="activeSection === 'dados'" class="content-section">
      <h2 class="page-title">Meus Dados</h2>
      <div class="data-grid">
        <div class="data-item">
          <label>Nome Completo</label>
          <p>{{ usuario.nome || 'Não informado' }}</p>
        </div>
        <div class="data-item">
          <label>Email</label>
          <p>{{ usuario.usuario?.email || 'Não informado' }}</p>
        </div>
        <div class="data-item">
          <label>CPF</label>
          <p>{{ usuario.usuario?.cpf || 'Não informado' }}</p>
        </div>
        <div class="data-item">
          <label>Data de Nascimento</label>
          <p>{{ usuario.dataNascimento || 'Não informado' }}</p>
        </div>
        <!-- Cartões Cadastrados -->
        <div class="data-item">
          <div class="card-credito-container">
            <mat-card class="mat-mdc-card-content cartao-conteudo">
              <mat-card-title class="mat-mdc-card-content cartao-conteudo">
                <mat-icon>credit_card</mat-icon>
                Cartões Cadastrados
              </mat-card-title>
              <mat-card-content class="mat-mdc-card-content cartao-conteudo">
                <div *ngIf="(usuario.cartoes?.length ?? 0) > 0; else nenhumCartao" class="mat-mdc-card-content cartao-conteudo">
                  <div class="cartao-item" *ngFor="let cartao of usuario.cartoes">
                    <mat-icon class="cartao-icon">credit_card</mat-icon>
                    <div class="cartao-info">
                      <div class="numero-cartao">**** **** **** {{ cartao.numero.slice(-4) }}</div>
                      <div class="nome-cartao">{{ cartao.titular }}</div>
                      <div class="validade-cartao">Validade: {{ cartao.dataValidade }}</div>
                    </div>
                  </div>
                </div>
                <ng-template #nenhumCartao>
                  <p>Nenhum cartão cadastrado.</p>
                </ng-template>
              </mat-card-content>
              <mat-card-actions class="mat-mdc-card-content cartao-conteudo">
                <button mat-flat-button color="primary" routerLink="/cliente/cartao-form" class="mat-mdc-card-content cartao-conteudo">
                  <mat-icon>add</mat-icon>
                  Adicionar Cartão
                </button>
              </mat-card-actions>
            </mat-card>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="activeSection === 'pedidos'" class="content-section">
      <h2 class="page-title">Meus Pedidos</h2>

      <div class="orders-list" *ngIf="pedidos.length > 0; else noPedidos">
        <div class="order-item" *ngFor="let pedido of pedidos">
          <div class="order-summary mat-elevation-z2">
            <header class="order-header">
              <h3 class="order-title">Pedido #{{ pedido.id }}</h3>
              <span class="order-date">
                {{ pedido.data | date: 'dd/MM/yyyy' }}
              </span>
            </header>

            <section class="order-details">
              <div class="order-info">
                <span class="order-label">Valor Total:</span>
                <span class="order-value">{{ pedido.valorTotal | currency: 'BRL':'symbol':'1.2-2' }}</span>
              </div>

              <div class="order-info">
                <span class="order-label">Pagamento:</span>
                <span class="order-value">{{ getTipoPagamentoLabel(pedido.tipoPagamento) }}</span>
              </div>

              <div class="order-info">
                <span class="order-label">Status:</span>
                <span class="order-status">
                  {{ getUltimoStatus(pedido) || 'Indefinido' }}
                </span>
              </div>

              <!-- ✅ Quando há imagens -->
              <div class="order-images" *ngIf="temImagensPedido(pedido)">
                <h4>Produtos:</h4>
                <div>
                  <button (click)="verDetalhes(pedido)">Ver detalhes</button>
                </div>

                <div class="image-gallery">
                  <div class="image-info-pair" *ngFor="let imgUrl of getImagensPedido(pedido); let i = index">
                    <img [src]="imgUrl" alt="Imagem da placa de vídeo" class="produto-img" />
                    <div class="info-placa1">
                      <span class="info"> </span>
                      <span class="info-placa">{{ getListaItemPedido(pedido) }}</span>
                    </div>
                  </div>
                </div>
              </div>


            </section>

            <!-- ✅ Imagens dos produtos -->


            <!-- ❌ Quando não há imagens -->
            <div class="order-images" *ngIf="pedido.id !== undefined && (!getImagensPedido(pedido)?.length)">
              <p class="no-img">Imagens não disponíveis para este pedido.</p>
            </div>



          </div>
        </div>
      </div>

      <ng-template #noPedidos>
        <p>Você ainda não fez nenhum pedido.</p>
      </ng-template>


    </div>


    <div *ngIf="activeSection === 'enderecos'" class="content-section">
      <h2 class="page-title">Endereços</h2>
      <div class="addresses-list" *ngIf="usuario.enderecos.length > 0; else noAddresses">
        <div class="address-item" *ngFor="let endereco of usuario.enderecos">
          <h3>{{ endereco.rua }}, {{ endereco.numero }}</h3>
          <p>{{ endereco.bairro }} - {{ endereco.cidade }}/{{ endereco.estado }}</p>
          <p>CEP: {{ endereco.cep }}</p>
          <p *ngIf="usuario.telefones.length > 0">
            Tel: ({{ usuario.telefones[0].codigoArea }}) {{ usuario.telefones[0].numero }}
          </p>
        </div>
      </div>
      <ng-template #noAddresses>
        <div class="empty-state">Nenhum endereço cadastrado</div>
      </ng-template>
    </div>

    <div *ngIf="activeSection === 'favoritos'" class="content-section">
      <h2 class="page-title">Meus Favoritos</h2>
      <div class="empty-state">Nenhum item favoritado</div>
    </div>
  </div>
</div>